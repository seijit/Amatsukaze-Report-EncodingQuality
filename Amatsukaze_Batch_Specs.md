# Amatsukaze バッチファイル運用仕様書

Amatsukazeのバッチファイル機能に関する仕様、環境変数、およびCMカット情報（Trim）の循環システムについてまとめる。

---

## 1. 基本仕様と設置ルール

Amatsukazeは、処理の各フェーズで特定の命名規則に従ったバッチファイルを自動認識し、実行する。

* **保存場所**: `(Amatsukaze設置フォルダ)\bat\` フォルダ内
* **認識ルール**: ファイル名の**接頭辞**によって、GUI上の設定可能な場所が自動的に振り分けられる。
* **設定場所の区分**:
    * **追加時ダイアログ**: ファイル追加時に表示される「Amatsukaze プロファイル＆出力先選択」画面で選択する。
        * 対象接頭辞: `追加時_`
    * **プロファイル設定**: 個別のエンコード設定画面で選択する。
        * 対象接頭辞: `実行前_`, `エンコード前_`, `実行後_`
    * **基本設定**: Amatsukaze全体の動作設定画面で選択する。
        * 対象接頭辞: `キュー完了後_`

---

## 2. 実行フェーズとタイミング

バッチファイルは処理の流れに応じ、以下のタイミングで実行される。

| フェーズ | 接頭辞 | 設定場所 (GUI) | タイミング・特徴 |
| :--- | :--- | :--- | :--- |
| **追加時** | `追加時_` | **追加時ダイアログ** | ファイルがキューに登録された瞬間に実行。タグ付与など。 |
| **実行前** | `実行前_` | **プロファイル設定** | タスク開始時。エンコード処理の開始直前。 |
| **エンコード前** | `エンコード前_` | **プロファイル設定** | **CM解析完了後**、エンコード(x264/QSV等)直前。<br>一時フォルダに `trim0.avs` が存在している。 |
| **実行後** | `実行後_` | **プロファイル設定** | タスク完了時 (Mux終了後)。|
| **キュー完了後** | `キュー完了後_` | **基本設定** | リスト内の全タスク終了後、最後に1回だけ実行。シャットダウン等。 |

* 一時ファイルの操作には `一時ファイルを削除せずに残す` 設定が必要。

---

## 3. 環境変数（変数継承）

実行時にAmatsukazeからバッチファイルへ渡される主な環境変数。実行モードで設定されるかどうかが変化する環境変数もある。

### 3.1 入力パス関連
* **`%IN_PATH%`**: Server管理上の入力ファイルフルパス。
* **`%IN_DIR%`**: 入力ファイルのあるフォルダパス。
* **`%IN_FILENAME%`**: 入力ファイル名（拡張子なし）。

### 3.2 中間・出力パス関連
* **`%OUT_DIR%`**: 出力先フォルダのパス。
* **`%OUT_PATH%`**: 出力動画ファイルのフルパス。
    * 最新の仕様では **拡張子が含まれません**。バッチファイル内で利用する際は、必要に応じて拡張子（.mp4,.mkv,.m2ts,.ts等）を補完して使用してください。
* **`%AMT_TEMP_DIR%`**: 処理中の一時フォルダパス。`trim0.avs` 等が格納される。
* **`%AMT_TEMP_VIDEO%`**: 映像中間ファイル（.raw等）のパス。

### 3.3 正規化パス・名称関連 (ZTOH)
パスやファイル名に含まれる全角文字を半角に正規化した変数群。
* **`%IN_PATH_ZTOH%` / `%OUT_PATH_ZTOH%`**: フルパスの正規化版。
* **`%IN_FILENAME_ZTOH%` / `%OUT_FILENAME_ZTOH%`**: ファイル名の正規化版。

### 3.4 番組メタデータ関連
* **`%EVENT_NAME%`**: EPGから取得された番組タイトル。
* **`%EVENT_GENRE%`**: 番組ジャンル（例: アニメ／特撮）。
* **`%SERVICE_NAME%`**: 放送局名。
* **`%SERVICE_ID%`**: サービスID。
* **`%TS_TIME%`**: 録画放送日時。

### 3.5 実行ステータス・結果関連
* **`%SUCCESS%`**: 処理結果フラグ（`1`で成功、`0`で失敗）。
* **`%ERROR_MESSAGE%`**: エラー発生時の詳細メッセージ。
* **`%ITEM_MODE%`**: 実行モード。`Batch` (通常), `AutoBatch` (自動追加), `Test` (テスト), `DrcsCheck` (DRCSチェック), `CMCheck` (CMチェック) 等。
* **`%PROFILE_NAME%`**: 適用されたプロファイル名。
* **`%LOG_PATH%`**: Amatsukazeの内部ログファイルへのパス。

### 3.6 注意点
* **パス区切り文字**: Amatsukaze内部では `/` が使われる場合がある。Windowsコマンド（`copy`等）で使用する際は `\` への置換が必要な場合がある。
* **空白処理**: パスに空白が含まれる可能性があるため、変数は必ず `"%CLI_IN_PATH%"` のように二重引用符で囲むこと。

---

## 4. CMカット情報 (Trim) の循環仕様

Amatsukazeには、外部ファイルと内部解析結果をリンクさせ、情報を維持する仕組みがある。

### 4.1 処理フロー
1.  **入力 (Load)**: タスク開始時、入力動画と同じ場所に `(入力名).ts.trim.avs` が存在すれば、自動的に読み込む。
2.  **解析 (Analysis)**: ロゴスキャンやCM判定処理自体はスキップされず実行されるが、**最終的なカット区間は読み込んだ外部ファイルの内容で上書き（優先）される**。
3.  **生成 (Generate)**: 一時フォルダ内に `trim0.avs` として確定情報が出力される。
4.  **出力 (Export)**: 「エンコード前バッチ」等で `trim0.avs` を `(入力名).ts.trim.avs` に書き戻す。

### 4.2 ループ挙動
* ユーザーが手動で `.ts.trim.avs` を修正しない限り、**「読込 A → 生成 A → 上書き出力 A」** となり、内容は維持される。
* 手動で修正（内容 B）を行うと、次回の処理で **「読込 B → 生成 B → 上書き出力 B」** となり、修正内容が新たな基準として維持される。

---

## 5. スクリプト例と設定

Trim情報を自動エクスポートし、手動でCMカット情報を修正するための構成。

### 5.1 プロファイル設定
* **`エンコード前バッチ`**: 作成したバッチファイル (`エンコード前_...bat`) を指定。
* **`一時ファイルを削除せずに残す`**: `true` (チェックを入れる)。一時ファイルを保持し、バッチからのアクセスを保証するため。

### 5.2 推奨バッチスクリプト (エンコード前バッチ用)
変数が確実に渡されるフェーズを利用した、最もシンプルで確実な記述。

```batch
:: 一時フォルダのtrim0.avsを入力フォルダへエクスポートする 

set "SRC=%AMT_TEMP_DIR%\trim0.avs"
set "DST=%CLI_IN_PATH%.trim.avs"

:: ファイルが存在すれば上書きコピー 
if exist "%SRC%" (
    copy /y "%SRC%" "%DST%"
    echo [INFO] Exported: %DST%
)
```